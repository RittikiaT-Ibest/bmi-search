
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ระบบค้นหาข้อมูล BMI นักเรียน</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 p-4">
<div class="max-w-7xl mx-auto">
  <h1 class="text-3xl font-bold mb-6 text-center">ระบบค้นหาข้อมูล BMI นักเรียน</h1>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
    <select id="searchId" class="p-2 border rounded"><option value="">เลขประจำตัว</option></select>
    <select id="searchName" class="p-2 border rounded"><option value="">ชื่อ</option></select>
    <select id="searchClass" class="p-2 border rounded"><option value="">ชั้น</option></select>
    <select id="searchRoom" class="p-2 border rounded"><option value="">ห้อง</option></select>
    <select id="searchAdvisor1" class="p-2 border rounded"><option value="">ครูที่ปรึกษา 1</option></select>
    <select id="searchAdvisor2" class="p-2 border rounded"><option value="">ครูที่ปรึกษา 2</option></select>
  </div>
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white border">
      <thead>
        <tr class="bg-gray-200 text-left">
          <th class="p-2">เลขประจำตัว</th>
          <th class="p-2">ชื่อ</th>
          <th class="p-2">ชั้น</th>
          <th class="p-2">ห้อง</th>
          <th class="p-2">น้ำหนัก</th>
          <th class="p-2">ส่วนสูง</th>
          <th class="p-2">BMI</th>
          <th class="p-2">แปลผล</th>
          <th class="p-2">ครูที่ปรึกษา 1</th>
          <th class="p-2">ครูที่ปรึกษา 2</th>
        </tr>
      </thead>
      <tbody id="dataBody"></tbody>
    </table>
  </div>
  <div class="flex justify-between mt-6 flex-wrap gap-4">
    <button onclick="showStats()" class="bg-blue-600 text-white px-4 py-2 rounded">ดูสถิติ</button>
    <div>
      <label for="advisorReport" class="block font-medium mb-2">เลือกครูที่ปรึกษาสำหรับรายงาน:</label>
      <select id="advisorReport" class="p-2 border rounded">
        <option value="">-- เลือกครูที่ปรึกษา --</option>
      </select>
      <button onclick="generatePDF()" class="ml-2 bg-green-600 text-white px-4 py-2 rounded">สร้างรายงาน PDF</button>
    </div>
  </div>
  <div id="statsSection" class="mt-10 hidden">
    <h2 class="text-2xl font-semibold mb-4">สถิติภาพรวม</h2>
    <canvas id="bmiChart" width="400" height="200"></canvas>
  </div>
</div>

<script>
const API_KEY = "AIzaSyD-IbEa-_poD4yLCaS6S3iCFd07U3x54-o";
const SHEET_ID = "1nR3b0kUrzFgRcGgdn1gF-tz-fZPEG08sbwjJr6H6qIE";
const SHEET_NAME = "database";
let allData = [];

async function fetchData() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  const rows = data.values;
  const headers = rows[0];
  allData = rows.slice(1).map(row => Object.fromEntries(headers.map((h, i) => [h, row[i] || ""])));
  renderTable(allData);
  populateDropdowns(allData);
}

function renderTable(data) {
  const body = document.getElementById("dataBody");
  body.innerHTML = data.map(row => `
    <tr>
      <td class="p-2 border">${row.student_id}</td>
      <td class="p-2 border">${row.name}</td>
      <td class="p-2 border">${row.class}</td>
      <td class="p-2 border">${row.room}</td>
      <td class="p-2 border">${row.weight}</td>
      <td class="p-2 border">${row.height}</td>
      <td class="p-2 border">${row.bmi}</td>
      <td class="p-2 border">${row.result}</td>
      <td class="p-2 border">${row.advisor_1}</td>
      <td class="p-2 border">${row.advisor_2}</td>
    </tr>`).join("");
}

function populateDropdowns(data) {
  const fields = ["student_id", "name", "class", "room", "advisor_1", "advisor_2"];
  fields.forEach(field => {
    const select = document.getElementById("search" + field.charAt(0).toUpperCase() + field.slice(1));
    const values = [...new Set(data.map(d => d[field]))].sort();
    values.forEach(val => {
      const option = document.createElement("option");
      option.value = val;
      option.text = val;
      select.appendChild(option);
    });
  });

  const advisorSelect = document.getElementById("advisorReport");
  const advisors = [...new Set(data.flatMap(d => [d.advisor_1, d.advisor_2]))].filter(Boolean).sort();
  advisors.forEach(name => {
    const option = document.createElement("option");
    option.value = name;
    option.text = name;
    advisorSelect.appendChild(option);
  });

  document.querySelectorAll("select").forEach(select => {
    select.addEventListener("change", () => {
      const filters = {};
      fields.forEach(field => {
        const val = document.getElementById("search" + field.charAt(0).toUpperCase() + field.slice(1)).value;
        if (val) filters[field] = val;
      });
      const filtered = allData.filter(row =>
        Object.entries(filters).every(([k, v]) => row[k] === v)
      );
      renderTable(filtered);
    });
  });
}

function showStats() {
  document.getElementById("statsSection").classList.remove("hidden");
  const count = { "ปกติ": 0, "ต่ำกว่าเกณฑ์": 0, "เกินเกณฑ์": 0, "อ้วน": 0 };
  allData.forEach(r => { if (count[r.result] !== undefined) count[r.result]++; });
  new Chart(document.getElementById("bmiChart"), {
    type: 'bar',
    data: {
      labels: Object.keys(count),
      datasets: [{ label: 'จำนวนนักเรียน', data: Object.values(count) }]
    }
  });
}

function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const advisor = document.getElementById("advisorReport").value;
  const now = new Date().toLocaleString("th-TH");
  doc.setFontSize(14);
  doc.text("โรงเรียนลำปาววิทยาคม", 10, 10);
  doc.text(`วันที่ออกรายงาน: ${now}`, 10, 20);
  const tableData = allData.map(r => [r.student_id, r.name, r.class, r.room, r.weight, r.height, r.bmi, r.result]);
  doc.autoTable({
    head: [["เลขประจำตัว", "ชื่อ", "ชั้น", "ห้อง", "น้ำหนัก", "ส่วนสูง", "BMI", "แปลผล"]],
    body: tableData,
    startY: 30
  });
  doc.text(`ครูที่ปรึกษา: ${advisor}`, 10, doc.lastAutoTable.finalY + 15);
  doc.text("ลงชื่อ: ..............................................................", 10, doc.lastAutoTable.finalY + 30);
  doc.save("รายงานข้อมูลนักเรียน.pdf");
}

fetchData();
</script>
</body>
</html>
